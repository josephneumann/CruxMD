/**
 * Application-level TypeScript types for CruxMD frontend.
 *
 * API types are auto-generated by @hey-api/openapi-ts in lib/generated/.
 * This file contains app-specific types and chat/agent types that mirror
 * the backend Pydantic schemas.
 */

import type { FhirPatient } from "./utils";

// Re-export generated types for convenience
export type { BundleLoadResponse } from "./generated";

// =============================================================================
// Chat API Types (mirrors backend/app/routes/chat.py)
// =============================================================================

/** Input validation constants matching backend limits */
export const MAX_MESSAGE_LENGTH = 10000;
export const MAX_CONVERSATION_HISTORY = 50;

/** Message role in conversation */
export type MessageRole = "user" | "assistant";

/** A single message in conversation history */
export interface ChatMessage {
  role: MessageRole;
  content: string;
}

/** Request body for POST /api/chat */
export interface ChatRequest {
  patient_id: string;
  message: string;
  conversation_id?: string;
  conversation_history?: ChatMessage[];
}

/** Response wrapper from POST /api/chat */
export interface ChatResponse {
  conversation_id: string;
  response: AgentResponse;
}

// =============================================================================
// Agent Response Types (mirrors backend/app/schemas/agent.py)
// =============================================================================

/** Query specification for resolving data at runtime */
export interface DataQuery {
  resource_types?: string[];
  filters?: Record<string, unknown>;
  time_range?: string;
  limit?: number;
}

/** Insight severity/category */
export type InsightType = "info" | "warning" | "critical" | "positive";

/** Clinical insight highlighted for the user */
export interface Insight {
  type: InsightType;
  title: string;
  content: string;
  citations?: string[];
}

/** Column format type */
export type ColumnFormat = "text" | "date" | "number" | "badge";

/** Column definition for a data table */
export interface TableColumn {
  key: string;
  header: string;
  format?: ColumnFormat;
}

/** Visualization type */
export type VisualizationType = "line_chart" | "bar_chart" | "timeline" | "vitals_grid";

/** Visualization specification for charts and graphs */
export interface Visualization {
  type: VisualizationType;
  title: string;
  description?: string;
  data_query: DataQuery;
  config?: Record<string, unknown>;
}

/** Table specification for displaying structured data */
export interface DataTable {
  title: string;
  columns: TableColumn[];
  data_query: DataQuery;
}

/** Action type category */
export type ActionType = "order" | "refer" | "document" | "alert" | "link";

/** Suggested action for the user to take */
export interface Action {
  label: string;
  type: ActionType;
  description?: string;
  payload?: Record<string, unknown>;
}

/** Suggested follow-up question for emergent navigation */
export interface FollowUp {
  question: string;
  intent?: string;
}

/** Structured response from the clinical reasoning agent */
export interface AgentResponse {
  thinking?: string;
  narrative: string;
  insights?: Insight[];
  visualizations?: Visualization[];
  tables?: DataTable[];
  actions?: Action[];
  follow_ups?: FollowUp[];
}

// =============================================================================
// Type Guards for Runtime Validation
// =============================================================================

/** Type guard for ChatMessage */
export function isChatMessage(obj: unknown): obj is ChatMessage {
  if (typeof obj !== "object" || obj === null) return false;
  const msg = obj as Record<string, unknown>;
  return (
    (msg.role === "user" || msg.role === "assistant") &&
    typeof msg.content === "string"
  );
}

/** Type guard for Insight */
export function isInsight(obj: unknown): obj is Insight {
  if (typeof obj !== "object" || obj === null) return false;
  const insight = obj as Record<string, unknown>;
  const validTypes: InsightType[] = ["info", "warning", "critical", "positive"];
  return (
    validTypes.includes(insight.type as InsightType) &&
    typeof insight.title === "string" &&
    typeof insight.content === "string"
  );
}

/** Type guard for FollowUp */
export function isFollowUp(obj: unknown): obj is FollowUp {
  if (typeof obj !== "object" || obj === null) return false;
  const followUp = obj as Record<string, unknown>;
  return typeof followUp.question === "string";
}

/** Type guard for AgentResponse */
export function isAgentResponse(obj: unknown): obj is AgentResponse {
  if (typeof obj !== "object" || obj === null) return false;
  const response = obj as Record<string, unknown>;
  // narrative is the only required field
  if (typeof response.narrative !== "string") return false;
  // Validate optional arrays if present
  if (response.insights !== undefined && !Array.isArray(response.insights)) return false;
  if (response.visualizations !== undefined && !Array.isArray(response.visualizations)) return false;
  if (response.tables !== undefined && !Array.isArray(response.tables)) return false;
  if (response.actions !== undefined && !Array.isArray(response.actions)) return false;
  if (response.follow_ups !== undefined && !Array.isArray(response.follow_ups)) return false;
  return true;
}

/** Type guard for ChatResponse */
export function isChatResponse(obj: unknown): obj is ChatResponse {
  if (typeof obj !== "object" || obj === null) return false;
  const response = obj as Record<string, unknown>;
  return (
    typeof response.conversation_id === "string" &&
    isAgentResponse(response.response)
  );
}

/**
 * Patient list item from API response.
 * Represents a single patient in the paginated response.
 */
export interface PatientListItem {
  id: string;
  fhir_id: string;
  data: FhirPatient;
}

/**
 * Paginated response for patient list.
 */
export interface PaginatedPatientList {
  items: PatientListItem[];
  total: number;
  skip: number;
  limit: number;
}

/**
 * Type guard to check if an object is a valid PatientListItem.
 */
export function isPatientListItem(obj: unknown): obj is PatientListItem {
  if (typeof obj !== "object" || obj === null) return false;
  const item = obj as Record<string, unknown>;
  return (
    typeof item.id === "string" &&
    typeof item.fhir_id === "string" &&
    typeof item.data === "object" &&
    item.data !== null
  );
}

/**
 * Type guard to check if an object is a valid PaginatedPatientList.
 */
export function isPaginatedPatientList(
  obj: unknown
): obj is PaginatedPatientList {
  if (typeof obj !== "object" || obj === null) return false;
  const data = obj as Record<string, unknown>;
  return (
    Array.isArray(data.items) &&
    typeof data.total === "number" &&
    typeof data.skip === "number" &&
    typeof data.limit === "number"
  );
}

/**
 * Parse and validate patient list from API response.
 * Handles both paginated response (new) and legacy array response (deprecated).
 */
export function parsePatientList(data: unknown): PatientListItem[] {
  // Handle paginated response (new format)
  if (isPaginatedPatientList(data)) {
    return data.items.filter(isPatientListItem);
  }
  // Handle legacy array response (deprecated)
  if (Array.isArray(data)) {
    return data.filter(isPatientListItem);
  }
  return [];
}
