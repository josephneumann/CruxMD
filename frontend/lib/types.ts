/**
 * Application-level TypeScript types for CruxMD frontend.
 *
 * API types are auto-generated by @hey-api/openapi-ts in lib/generated/.
 * This file contains only app-specific types that extend the generated ones.
 */

import type { FhirPatient } from "./utils";

// Re-export generated types for convenience
export type { BundleLoadResponse } from "./generated";

/**
 * Patient list item from API response.
 * Represents a single patient in the paginated response.
 */
export interface PatientListItem {
  id: string;
  fhir_id: string;
  data: FhirPatient;
}

/**
 * Paginated response for patient list.
 */
export interface PaginatedPatientList {
  items: PatientListItem[];
  total: number;
  skip: number;
  limit: number;
}

/**
 * Type guard to check if an object is a valid PatientListItem.
 */
export function isPatientListItem(obj: unknown): obj is PatientListItem {
  if (typeof obj !== "object" || obj === null) return false;
  const item = obj as Record<string, unknown>;
  return (
    typeof item.id === "string" &&
    typeof item.fhir_id === "string" &&
    typeof item.data === "object" &&
    item.data !== null
  );
}

/**
 * Type guard to check if an object is a valid PaginatedPatientList.
 */
export function isPaginatedPatientList(
  obj: unknown
): obj is PaginatedPatientList {
  if (typeof obj !== "object" || obj === null) return false;
  const data = obj as Record<string, unknown>;
  return (
    Array.isArray(data.items) &&
    typeof data.total === "number" &&
    typeof data.skip === "number" &&
    typeof data.limit === "number"
  );
}

/**
 * Parse and validate patient list from API response.
 * Handles both paginated response (new) and legacy array response (deprecated).
 */
export function parsePatientList(data: unknown): PatientListItem[] {
  // Handle paginated response (new format)
  if (isPaginatedPatientList(data)) {
    return data.items.filter(isPatientListItem);
  }
  // Handle legacy array response (deprecated)
  if (Array.isArray(data)) {
    return data.filter(isPatientListItem);
  }
  return [];
}
